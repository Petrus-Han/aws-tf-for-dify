# Dify 部署架构

## 架构图

```
                                     AWS Cloud (Region: us-west-2)
┌────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │ VPC (10.0.0.0/16)                                                                       │   │
│  │                                                                                         │   │
│  │  ┌─────────────────┐        ┌─────────────────┐                                         │   │
│  │  │ Public Subnet 1 │        │ Public Subnet 2 │                                         │   │
│  │  │ 10.0.1.0/24     │        │ 10.0.2.0/24     │                                         │   │
│  │  │                 │        │                 │                                         │   │
│  │  │  ┌───────────┐  │        │  ┌───────────┐  │                                         │   │
│  │  │  │ NAT GW 1  │  │        │  │ NAT GW 2  │  │                                         │   │
│  │  │  └───────────┘  │        │  └───────────┘  │                                         │   │
│  │  └────────┬────────┘        └────────┬────────┘                                         │   │
│  │           │                          │                                                  │   │
│  │           │                          │                                                  │   │
│  │  ┌────────▼────────┐        ┌────────▼────────┐                                         │   │
│  │  │ Private Subnet 1│        │ Private Subnet 2│                                         │   │
│  │  │ 10.0.10.0/24    │        │ 10.0.11.0/24    │                                         │   │
│  │  │                 │        │                 │                                         │   │
│  │  │  ┌───────────┐  │        │  ┌───────────┐  │                                         │   │
│  │  │  │           │  │        │  │           │  │                                         │   │
│  │  │  │  EKS      ◄──┼────────┼──►           │  │                                         │   │
│  │  │  │  Cluster  │  │        │  │  EKS      │  │                                         │   │
│  │  │  │           │  │        │  │  Nodes    │  │                                         │   │
│  │  │  └─────┬─────┘  │        │  │           │  │                                         │   │
│  │  │        │        │        │  └─────┬─────┘  │                                         │   │
│  │  │        │        │        │        │        │                                         │   │
│  │  │        ▼        │        │        │        │                                         │   │
│  │  │  ┌───────────┐  │        │  ┌─────▼─────┐  │        ┌───────────────────────┐        │   │
│  │  │  │ Aurora    │  │        │  │           │  │        │                       │        │   │
│  │  │  │ Serverless│◄─┼────────┼──► Redis     │  │        │ ECR Repository        │        │   │
│  │  │  │ PostgreSQL│  │        │  │ Cache     │  │        │ (dify-test)           │        │   │
│  │  │  └───────────┘  │        │  └───────────┘  │        │                       │        │   │
│  │  │                 │        │                 │        └───────────────────────┘        │   │
│  │  │  ┌───────────┐  │        │  ┌───────────┐  │                                         │   │
│  │  │  │           │  │        │  │           │  │        ┌───────────────────────┐        │   │
│  │  │  │ OpenSearch│◄─┼────────┼──►           │  │        │                       │        │   │
│  │  │  │ Domain    │  │        │  │           │  │        │ S3 Bucket             │        │   │
│  │  │  └───────────┘  │        │  └───────────┘  │        │ (dify-test-storage)   │        │   │
│  │  │                 │        │                 │        │                       │        │   │
│  │  └─────────────────┘        └─────────────────┘        └───────────────────────┘        │   │
│  │                                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                │
└────────────────────────────────────────────────────────────────────────────────────────────────┘
```

## 架构详情

根据Terraform代码，这是一个在AWS上部署的完整Dify应用架构，主要包含以下组件：

### 网络架构
- **VPC**: 10.0.0.0/16 CIDR块
- **公共子网**: 两个可用区的公共子网(10.0.1.0/24, 10.0.2.0/24)
- **私有子网**: 两个可用区的私有子网(10.0.10.0/24, 10.0.11.0/24)
- **NAT网关**: 每个公共子网一个NAT网关，用于私有子网访问互联网
- **互联网网关**: 用于公共子网访问互联网

### 计算资源
- **EKS集群**: 
  - Kubernetes版本: 1.33
  - 控制平面部署在私有子网
  - 测试环境: 1个m7g.xlarge节点(4 vCPU, 16GB内存)
  - 生产环境: 6个m7g.2xlarge节点(8 vCPU, 32GB内存)
  - 使用ARM架构的Graviton处理器

### 数据存储
- **Aurora Serverless v2 PostgreSQL**:
  - 版本: 17.5
  - 测试环境: 0.5-4 ACU
  - 生产环境: 1-8 ACU
  - 部署在私有子网

- **ElastiCache Redis**:
  - 版本: 7.1
  - 测试环境: cache.t4g.micro (1GB内存)
  - 生产环境: cache.t4g.small (2GB内存)
  - 部署在私有子网

- **OpenSearch服务**:
  - 版本: OpenSearch 2.19
  - 测试环境: m6g.large.search (4 vCPU, 8GB内存)，1个节点
  - 生产环境: m6g.4xlarge.search (16 vCPU, 64GB内存)，3个节点
  - 部署在私有子网

### 存储与镜像
- **S3存储桶**: 用于Dify应用数据存储
  - 启用版本控制
  - 启用服务器端加密
  - 阻止公共访问

- **ECR仓库**: 
  - **主应用仓库**: 存储Dify应用的Docker镜像
  - **EE插件仓库**: 存储Dify EE插件镜像
  - 启用镜像扫描
  - 生命周期策略（主应用保留10个镜像，插件保留20个镜像）

### 安全与访问控制
- 为每个服务配置了专用安全组
- EKS集群使用IAM角色进行权限管理
- 使用OIDC提供商实现Kubernetes服务账户与AWS IAM的集成
- **Dify EE IRSA角色**:
  - `DifyEE-Role-{cluster}-s3`: S3访问权限（用于dify-api）
  - `DifyEE-Role-{cluster}-s3-ecr`: S3+ECR完整访问权限（用于dify-plugin-crd）
  - `DifyEE-Role-{cluster}-ecr-image-pull`: ECR镜像拉取权限（用于dify-plugin-runner）
- **Kubernetes ServiceAccounts**: 自动创建并配置IRSA注解

### 环境配置
- 支持测试(test)和生产(prod)两种环境
- 根据环境自动调整资源规格和配置
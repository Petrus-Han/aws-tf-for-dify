## 要求

> 该要求可以支持最多 `3000` 个活跃用户每天。如果你有更多用户，可以根据需要扩展资源。

-   Kubernetes 集群
    -   6 个工作节点：每个 8 CPU，32 GB RAM
-   容器镜像仓库（插件）
    -   AWS ECR（with AK/SK or IRSA）/ Azure ACR / Aliyun ACR (with AK/SK) / Tencent TCR (with AK/SK) / Dockerhub / Google Artifact Registry
-   持久化存储
    -   S3 / AWS S3 (with AK/SK or IRSA) / Azure Blob / Aliyun OSS (with AK/SK) / Tencent COS (with AK/SK) / Google GCS
    -   512 GB 存储
-   Postgres 数据库
    -   版本 14+
    -   4 CPU，8 GB RAM
    -   512 GB `SSD` 存储
-   Redis 数据库
    -   版本 6+
    -   2 GB RAM
-   [向量数据库虚拟机 - Qdrant 集群](https://enterprise-docs.dify.ai/versions/3-0-x/zh-cn/deployment/advanced-configuration/qdrant/qdrant-cluster)
    -   3 个虚拟机
    -   8 CPU，64 GB RAM
    -   100 GB 存储

## Dify 服务资源的 `limits`

|      Services      | Replicas | CPU | RAM - GB | Total CPU | Total RAM - GB |
|--------------------|----------|-----|----------|-----------|----------------|
|        api         |    3     |  3  |    10    |     9     |       30       |
|       worker       |    3     |  2  |    10    |     6     |       30       |
|        web         |    3     |  1  |    1     |     3     |       3        |
|      sandbox       |    3     |  1  |    2     |     3     |       6        |
|     enterprise     |    3     |  1  |    2     |     3     |       6        |
|  enterpriseAudit   |    3     |  1  |    2     |     3     |       6        |
| enterpriseFrontend |    3     |  1  |    1     |     3     |       3        |
|     ssrfProxy      |    3     |  1  |    1     |     3     |       3        |
|    unstructured    |    3     |  1  |    2     |     3     |       6        |
|   plugin\_daemon   |    3     |  1  |    3     |     3     |       9        |
| plugin\_controller |    3     |  1  |    2     |     3     |       6        |
| plugin\_connector  |    3     |  1  |    2     |     3     |       6        |
|      gateway       |    3     |  1  |    2     |     3     |       6        |
|       minio        |    1     |  1  |    2     |     1     |       2        |
|                    |          |     |  **Total**   |    49     |      122       |

## 部署

### 1\. 获取 Helm 仓库信息

```csharp
helm repo add dify https://langgenius.github.io/dify-helm
helm repo update
```

有关更多信息，请参阅 [Dify Helm Chart](https://enterprise-docs.dify.ai/versions/3-0-x/zh-cn/deployment/advanced-configuration/dify-helm-chart)。

### 2\. 保存 Helm Chart 值

-   将 Helm chart 值保存到名为 `values.yaml` 的文件中。
-   使用你的配置更新 `values.yaml` 文件。

```yaml
###################################
# Please replace "dify123456" with your own value
###################################
global:
  appSecretKey: 'dify123456'
  consoleApiDomain: "console.dify.local"
  consoleWebDomain: "console.dify.local"
  serviceApiDomain: "api.dify.local"
  appApiDomain: "app.dify.local"
  appWebDomain: "app.dify.local"
  filesDomain: "upload.dify.local"
  enterpriseDomain: "enterprise.dify.local"

ingress:
  enabled: true
  className: "nginx"
  annotations: {
    # set file upload size limit
    nginx.ingress.kubernetes.io/proxy-body-size: "15m"
  }

api:
  replicas: 3
  serverWorkerAmount: 1
  innerApi:
    apiKey: "dify123456"
  resources:
    limits:
      cpu: 3000m
      memory: 10240Mi
    requests:
      cpu: 1500m
      memory: 5120Mi
worker:
  replicas: 3
  celeryWorkerAmount: 1
  resources:
    limits:
      cpu: 2000m
      memory: 10240Mi
    requests:
      cpu: 1000m
      memory: 5120Mi
web:
  replicas: 3
  resources:
    limits:
      cpu: 1000m
      memory: 1024Mi
    requests:
      cpu: 500m
      memory: 512Mi
sandbox:
  replicas: 3
  apiKey: "dify123456"
  resources:
    limits:
      cpu: 1000m
      memory: 2048Mi
    requests:
      cpu: 500m
      memory: 1024Mi
enterprise:
  replicas: 3
  appSecretKey: "dify123456"
  adminAPIsSecretKeySalt: "dify123456"
  innerApi:
    apiKey: "dify123456"
  resources:
    limits:
      cpu: 1000m
      memory: 2048Mi
    requests:
      cpu: 500m
      memory: 1024Mi
enterpriseAudit:
  replicas: 3
  resources:
    limits:
      cpu: 1000m
      memory: 2048Mi
    requests:
      cpu: 500m
      memory: 1024Mi
enterpriseFrontend:
  replicas: 3
  resources:
    limits:
      cpu: 1000m
      memory: 1024Mi
    requests:
      cpu: 500m
      memory: 512Mi
ssrfProxy:
  enabled: true
  replicas: 3
  resources:
    limits:
      cpu: 1000m
      memory: 1024Mi
    requests:
      cpu: 500m
      memory: 512Mi
unstructured:
  enabled: true
  replicas: 3
  resources:
    limits:
      cpu: 1000m
      memory: 2048Mi
    requests:
      cpu: 500m
      memory: 1024Mi
plugin_daemon:
  replicas: 3
  apiKey: "dify123456"
  resources:
    limits:
      cpu: 1000m
      memory: 3072Mi
    requests:
      cpu: 500m
      memory: 1536Mi
plugin_controller:
  replicas: 3
  resources:
    limits:
      cpu: 1000m
      memory: 2048Mi
    requests:
      cpu: 500m
      memory: 1024Mi
plugin_connector:
  replicas: 3
  apiKey: "dify123456"
  resources:
    limits:
      cpu: 1000m
      memory: 2048Mi
    requests:
      cpu: 500m
      memory: 1024Mi
gateway:
  replicas: 3
  resources:
    limits:
      cpu: 1000m
      memory: 2048Mi
    requests:
      cpu: 500m
      memory: 1024Mi
minio:
  replicas: 1
  resources:
    limits:
      cpu: 1000m
      memory: 2048Mi
    requests:
      cpu: 500m
      memory: 1024Mi

###################################
# Persistence Configration
###################################
persistence:
  type: "s3"
  s3:
    endpoint: "https://xxx.r2.cloudflarestorage.com"
    accessKey: "#REPLACE_ME#"
    secretKey: "#REPLACE_ME#"
    region: "us-east-1"
    bucketName: "your-bucket-name"
    addressType: ""
    useAwsManagedIam: false
    useAwsS3: true

###################################
# External postgres
###################################
externalPostgres:
  enabled: true
  address: "#REPLACE_ME#"
  port: 5432
  credentials:
    dify:
      database: "dify"
      username: "postgres"
      password: "#REPLACE_ME#"
      sslmode: "require"
    plugin_daemon:
      database: "dify_plugin_daemon"
      username: "postgres"
      password: "#REPLACE_ME#"
      sslmode: "require"
    enterprise:
      database: "enterprise"
      username: "postgres"
      password: "#REPLACE_ME#"
      sslmode: "require"
    audit:
      database: "audit"
      username: "postgres"
      password: "#REPLACE_ME#"
      sslmode: "require"

###################################
# External Redis
###################################
externalRedis:
  enabled: true
  host: "#REPLACE_ME#"
  port: 6379
  username: ""
  password: "#REPLACE_ME#"
  useSSL: false

###################################
# External Qdrant
###################################
vectorDB:
  useExternal: true
  externalType: "qdrant"
  externalQdrant:
    endpoint: "http://your-qdrant-cluster-url.qdrant.tech/"
    apiKey: "#REPLACE_ME#"

imagePullSecrets: []
```

### 3\. 配置 `容器镜像仓库`

-   3.1 配置 `插件` 容器镜像仓库
    -   更多信息，请参考 [插件的容器镜像仓库配置](https://enterprise-docs.dify.ai/versions/3-0-x/zh-cn/deployment/advanced-configuration/container-registry-for-plugins)。
-   3.2 配置 `服务` 容器镜像仓库
    -   更多信息，请参考 [容器镜像仓库配置](https://enterprise-docs.dify.ai/versions/3-0-x/zh-cn/deployment/advanced-configuration/container-registry)。

### 4\. 配置 `Persistence Storage`

-   更多信息，请参考 [Persistence Storage](https://enterprise-docs.dify.ai/versions/3-0-x/zh-cn/deployment/advanced-configuration/persistent-storage)。

### 5\. 配置 `External postgres`

-   更多信息，请参考 [External postgres](https://enterprise-docs.dify.ai/versions/3-0-x/zh-cn/deployment/advanced-configuration/postgresql-database)。

### 6\. 配置 `External Redis`

-   更多信息，请参考 [External Redis](https://enterprise-docs.dify.ai/versions/3-0-x/zh-cn/deployment/advanced-configuration/redis)。

### 7\. 配置 `External Qdrant`

-   更多信息，请参考 [External Qdrant Cluster](https://enterprise-docs.dify.ai/versions/3-0-x/zh-cn/deployment/advanced-configuration/qdrant/qdrant-cluster)。

### 8\. 配置 `Ingress Controller`

-   更多信息，请参考 [Ingress Controller 配置](https://enterprise-docs.dify.ai/versions/3-0-x/zh-cn/deployment/advanced-configuration/nginx-ingress-controller)。

### 9\. 安装 Dify Helm Chart

```bash
helm upgrade -i dify -f values.yaml dify/dify
```

### 10\. 验证安装结果

-   更多信息，请参考 [服务状态验证](https://enterprise-docs.dify.ai/versions/3-0-x/zh-cn/deployment/verify-services-status)。

## 高级配置

### 1\. 域名与 SSL 证书

-   更多信息，请参考 [域名与 SSL 证书配置](https://enterprise-docs.dify.ai/versions/3-0-x/zh-cn/deployment/advanced-configuration/domain-and-ssl-certificate)。

### 2\. 邮件服务提供商

-   更多信息，请参考 [邮件服务配置](https://enterprise-docs.dify.ai/versions/3-0-x/zh-cn/deployment/advanced-configuration/email-provider)。

### 3\. 性能调优

-   更多信息，请参考 [性能调优](https://enterprise-docs.dify.ai/versions/3-0-x/zh-cn/deployment/advanced-configuration/performance)。